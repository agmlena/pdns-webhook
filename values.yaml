# external-dns Helm values – Rust PowerDNS HTTPS webhook sidecar
# helm upgrade --install external-dns external-dns/external-dns -f values.yaml
#
# Create the secret first:
#   kubectl create secret generic powerdns-api-key \
#     --from-literal=api-key=<YOUR_KEY>

provider:
  name: webhook

extraArgs:
  - --webhook-provider-url=http://localhost:8888
  - --managed-record-types=HTTPS
  - --managed-record-types=A
  - --managed-record-types=AAAA
  - --managed-record-types=CNAME
  - --managed-record-types=TXT
  - --txt-owner-id=external-dns
  - --source=ingress
  - --source=service

sidecars:
  - name: pdns-webhook
    image: ghcr.io/your-org/external-dns-pdns-webhook-rs:latest  # ← replace
    imagePullPolicy: IfNotPresent
    ports:
      - name: webhook
        containerPort: 8888

    # ── Non-sensitive config only ────────────────────────────────────────────
    env:
      - name: PDNS_API_URL
        value: "http://powerdns.powerdns.svc.cluster.local:8081"
      - name: PDNS_SERVER_ID
        value: "localhost"
      - name: DOMAIN_FILTER
        value: "example.com,example.net"
      - name: DEFAULT_TTL
        value: "300"
      - name: RUST_LOG
        value: "external_dns_pdns_webhook=info,tower_http=warn"
      # Tell the app where to find the secret file
      - name: PDNS_API_KEY_FILE
        value: "/var/run/secrets/pdns/api-key"

    # ── Mount the Kubernetes Secret as a read-only file ──────────────────────
    volumeMounts:
      - name: pdns-secret
        mountPath: /var/run/secrets/pdns
        readOnly: true

    livenessProbe:
      httpGet:
        path: /healthz
        port: 8888
      initialDelaySeconds: 5
      periodSeconds: 10
    readinessProbe:
      httpGet:
        path: /healthz
        port: 8888
      initialDelaySeconds: 5
      periodSeconds: 10

# ── Volume sourced from the Kubernetes Secret ─────────────────────────────────
extraVolumes:
  - name: pdns-secret
    secret:
      secretName: powerdns-api-key   # kubectl create secret generic powerdns-api-key --from-literal=api-key=<KEY>
      defaultMode: 0400              # owner read-only; prevents other processes reading the file
      items:
        - key: api-key
          path: api-key              # mounted at /var/run/secrets/pdns/api-key
